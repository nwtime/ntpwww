<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="UTF-8">
  <META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">
  
  

  
  <meta name="description" content="Last update: 10-Mar-2014 05:05 UTC

The clock filter algorithm processes the offset and delay samples produced by the on-wire protocol for each peer …">
<meta property="og:title" content="Clock Filter Algorithm" />
<meta property="og:description" content="Last update: 10-Mar-2014 05:05 UTC
 The clock filter algorithm processes the offset and delay samples produced by the on-wire protocol for each peer process separately. It uses a sliding window of eight samples and picks out the sample with the least expected error. This page describes the algorithm design principles along with an example of typical performance.
Figure 1: Wedge Scattergram
Figure 1 shows a typical wedge scattergram plotting sample points of offset versus delay collected over a 24-hr period." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://test.doc.ntp.org/archives/4.2.8-series/filter/" /><meta property="article:section" content="archives" />

<meta property="og:site_name" content="NTP: Network Time Protocol" />



  
  <title>Clock Filter Algorithm</title>

  <!-- Mobile Responsive Meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="NTP Documentation Archive">
  
  <meta name="generator" content="Hugo 0.83.1" />

  <!-- Plugins -->
  
    <link rel="stylesheet" href="https://necolas.github.io/normalize.css/latest/normalize.css">
  
    <link rel="stylesheet" href="https://test.doc.ntp.org/plugins/bootstrap/bootstrap.min.css">
  

  <!-- Main Stylesheet -->
  
  <link rel="stylesheet" href="https://test.doc.ntp.org/scss/nwtime.min.css" media="screen">

  <!-- Favicon -->
  <link rel="shortcut icon" href="https://test.doc.ntp.org/images/favicon.png " type="image/x-icon">
  <link rel="icon" href="https://test.doc.ntp.org/images/favicon.png " type="image/x-icon">
</head>
<body><!-- navigation -->
    

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">

<header class="sticky-top navigation">
  <div class="container">


    <nav class="navbar navbar-expand-lg navbar-light py-0">
	  <div class="d-flex align-items-center" style="height:80px; width:80px;">
		 <a class="py-0 mx-1" href="https://www.nwtime.org"><img class="img-fluid" src="https://test.doc.ntp.org/images/logo.png" alt=""></a>
      </div>
	  <div class="d-flex align-items-center" style="height:80px; width:80px;">
		 <a class="navbar-brand py-0 mx-1" href="https://test.doc.ntp.org/"><img class="img-fluid" src="https://test.doc.ntp.org/images/ntp_logo.jpg" alt="NTP: Network Time Protocol"></a> 
      </div>
	  <button class="navbar-toggler border-0" type="button" data-toggle="collapse" data-target="#navigation">
        <i class="bi-plus"></i>
      </button>

      <div class="collapse navbar-collapse text-center" id="navigation">
        <ul class="navbar-nav ml-auto py-0">
          <li class="nav-item py-0">
            <a class="nav-link py-0" style="text-decoration: none; font-size: 16px; font-family: 'Nunito Sans', sans-serif;" href="https://test.doc.ntp.org/"></a>
          </li>
          
          
          <li class="nav-item dropdown py-0">
            <a class="nav-link dropdown-toggle py-0" style="text-decoration: none; font-size: 16px; font-family: 'Nunito Sans', sans-serif;" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Support
            </a>
            <div class="dropdown-menu">
              
              <a class="dropdown-item" style="text-decoration: none; font-size: 16px; font-family: 'Nunito Sans', sans-serif;" href="https://support.ntp.org/">Support Wiki</a>
              
              <a class="dropdown-item" style="text-decoration: none; font-size: 16px; font-family: 'Nunito Sans', sans-serif;" href="https://support.ntp.org/bin/view/Servers/WebHome">Time Servers</a>
              
              <a class="dropdown-item" style="text-decoration: none; font-size: 16px; font-family: 'Nunito Sans', sans-serif;" href="https://support.ntp.org/bin/view/Main/SecurityNotice">Security Notices</a>
              
              <a class="dropdown-item" style="text-decoration: none; font-size: 16px; font-family: 'Nunito Sans', sans-serif;" href="https://test.doc.ntp.org/ntpfaq">FAQ</a>
              
              <a class="dropdown-item" style="text-decoration: none; font-size: 16px; font-family: 'Nunito Sans', sans-serif;" href="https://support.ntp.org/bin/view/Dev/WebHome">Developer Resources</a>
              
              <a class="dropdown-item" style="text-decoration: none; font-size: 16px; font-family: 'Nunito Sans', sans-serif;" href="https://test.doc.ntp.org/contributorslist">Contributors List</a>
              
              <a class="dropdown-item" style="text-decoration: none; font-size: 16px; font-family: 'Nunito Sans', sans-serif;" href="https://test.doc.ntp.org/contact">Contacts</a>
              
            </div>
          </li>
          
          
          
          <li class="nav-item dropdown py-0">
            <a class="nav-link dropdown-toggle py-0" style="text-decoration: none; font-size: 16px; font-family: 'Nunito Sans', sans-serif;" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Reference Library
            </a>
            <div class="dropdown-menu">
              
              <a class="dropdown-item" style="text-decoration: none; font-size: 16px; font-family: 'Nunito Sans', sans-serif;" href="https://test.doc.ntp.org/reflib/brief">Briefs</a>
              
              <a class="dropdown-item" style="text-decoration: none; font-size: 16px; font-family: 'Nunito Sans', sans-serif;" href="https://test.doc.ntp.org/reflib/memos">Memos</a>
              
              <a class="dropdown-item" style="text-decoration: none; font-size: 16px; font-family: 'Nunito Sans', sans-serif;" href="https://test.doc.ntp.org/reflib/reports">Reports</a>
              
              <a class="dropdown-item" style="text-decoration: none; font-size: 16px; font-family: 'Nunito Sans', sans-serif;" href="https://test.doc.ntp.org/reflib/rfc">RFCs</a>
              
              <a class="dropdown-item" style="text-decoration: none; font-size: 16px; font-family: 'Nunito Sans', sans-serif;" href="https://test.doc.ntp.org/reflib/software">Software</a>
              
              <a class="dropdown-item" style="text-decoration: none; font-size: 16px; font-family: 'Nunito Sans', sans-serif;" href="https://test.doc.ntp.org/reflib/papers">White Papers</a>
              
            </div>
          </li>
          
          
          
          <li class="nav-item dropdown py-0">
            <a class="nav-link dropdown-toggle py-0" style="text-decoration: none; font-size: 16px; font-family: 'Nunito Sans', sans-serif;" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Documentation
            </a>
            <div class="dropdown-menu">
              
              <a class="dropdown-item" style="text-decoration: none; font-size: 16px; font-family: 'Nunito Sans', sans-serif;" href="https://test.doc.ntp.org/archives/4.2.8-series/toc">4.2.8-series</a>
              
              <a class="dropdown-item" style="text-decoration: none; font-size: 16px; font-family: 'Nunito Sans', sans-serif;" href="https://test.doc.ntp.org/archives/4.2.6-series/toc">4.2.6-series</a>
              
              <a class="dropdown-item" style="text-decoration: none; font-size: 16px; font-family: 'Nunito Sans', sans-serif;" href="https://test.doc.ntp.org/archives/4.2.4-series/toc">4.2.4-series</a>
              
              <a class="dropdown-item" style="text-decoration: none; font-size: 16px; font-family: 'Nunito Sans', sans-serif;" href="https://test.doc.ntp.org/archives/4.2.2-series/toc">4.2.2-series</a>
              
              <a class="dropdown-item" style="text-decoration: none; font-size: 16px; font-family: 'Nunito Sans', sans-serif;" href="https://test.doc.ntp.org/archives/4.2.0/toc">4.2.0</a>
              
              <a class="dropdown-item" style="text-decoration: none; font-size: 16px; font-family: 'Nunito Sans', sans-serif;" href="https://test.doc.ntp.org/archives/4.1.2/toc">4.1.2</a>
              
              <a class="dropdown-item" style="text-decoration: none; font-size: 16px; font-family: 'Nunito Sans', sans-serif;" href="https://test.doc.ntp.org/archives/4.1.1/toc">4.1.1</a>
              
              <a class="dropdown-item" style="text-decoration: none; font-size: 16px; font-family: 'Nunito Sans', sans-serif;" href="https://test.doc.ntp.org/archives/4.1.0/toc">4.1.0</a>
              
              <a class="dropdown-item" style="text-decoration: none; font-size: 16px; font-family: 'Nunito Sans', sans-serif;" href="https://test.doc.ntp.org/archives/3-5.93e/toc">3-5.93e</a>
              
            </div>
          </li>
          
          
        </ul>
      </div>
	  
      <script async src="https://cse.google.com/cse.js?cx=bb3c9b3e375d856be"></script>
      <div class="gcse-search">
      </div>

    </nav>
  </div>
  <div class="header-border">
  </div>
</header>
<!-- /navigation --><nav aria-label="breadcrumb" class="d-none d-md-block d-print-none">
	<ol class="breadcrumb spb-1">
		










<li class="breadcrumb-item" >
	<a href="https://test.doc.ntp.org/documentation/">Documentation</a>
</li>




<li class="breadcrumb-item" >
	<a href="https://test.doc.ntp.org/archives/4.2.8-series/">4.2.8-series</a>
</li>




<li class="breadcrumb-item active" aria-current="page">
	<a href="https://test.doc.ntp.org/archives/4.2.8-series/filter/">Clock Filter Algorithm</a>
</li>

	</ol>
</nav	>


<section class="section pt-0  pb-auto">
  <div class="container">
  	<h1>Clock Filter Algorithm</h1>
     
    <p>Last update: 10-Mar-2014 05:05 UTC</p>
<hr>
<p>The clock filter algorithm processes the offset and delay samples produced by the on-wire protocol for each peer process separately. It uses a sliding window of eight samples and picks out the sample with the least expected error. This page describes the algorithm design principles along with an example of typical performance.</p>
<p><img src="/archives/pic/flt5.gif" alt="gif"></p>
<p><strong>Figure 1: Wedge Scattergram</strong></p>
<p>Figure 1 shows a typical <em>wedge scattergram</em> plotting sample points of offset versus delay collected over a 24-hr period. As the delay increases, the offset variation increases, so the best samples are those at the lowest delay. There are two limb lines at slope ±0.5, representing the limits of sample variation. However, it is apparent that, if a way could be found to find the sample of lowest delay, it would have the least offset variation and would be the best candidate to synchronize the system clock.</p>
<p>The clock filter algorithm works best when the delays are statistically identical in the reciprocal directions between the server and client. This is apparent in Figure 1, where the scattergram is symmetric about the x axis through the apex sample. In configurations where the delays are not reciprocal, or where the transmission delays on the two directions are traffic-dependent, this may not be the case. A common case with DSL links is when downloading or uploading a large file. During the download or upload process, the delays may be significantly different resulting in large errors. However, these errors can be largely eliminated using samples near the limb lines, as described on the <a href="/archives/4.2.8-series/huffpuff">Huff-n'-Puff Filter</a> page.</p>
<p>In the clock filter algorithm the offset and delay samples from the on-wire protocol are inserted as the youngest stage of an eight-stage shift register, thus discarding the oldest stage. Each time an NTP packet is received from a source, a dispersion sample is initialized as the sum of the precisions of the server and client. Precision is defined by the latency to read the system clock and varies from 1000 ns to 100 ns in modern machines. The dispersion sample is inserted in the shift register along with the associated offset and delay samples. Subsequently, the dispersion sample in each stage is increased at a fixed rate of 15 μs/s, representing the worst case error due to skew between the server and client clock frequencies.</p>
<p>In each peer process the clock filter algorithm selects the stage with the smallest delay, which generally represents the most accurate data, and it and the associated offset sample become the peer variables of the same name. The peer jitter statistic is computed as the root mean square (RMS) differences between the offset samples and the offset of the selected stage.</p>
<p>The peer dispersion statistic is determined as a weighted sum of the dispersion samples in the shift register. Initially, the dispersion of all shift register stages is set to a large number &ldquo;infinity&rdquo; equal to 16 s. The weight factor for each stage, starting from the youngest numbered <em>i</em> = 1, is 2<sup>-<em>i</em></sup>, which means the peer dispersion is approximately 16 s.</p>
<p>As samples enter the register, the peer dispersion drops from 16 s to 8 s, 4 s, 2 s, and so forth. In practice, the synchronization distance, which is equal to one-half the delay plus the dispersion, falls below the select threshold of 1.5 s in about four updates. This gives some time for meaningful comparison between sources, if more than one are available. The dispersion continues to grow at the same rate as the sample dispersion. For additional information on statistical principles and performance metrics, see the <a href="/archives/4.2.8-series/stats">Performance Metrics</a> page.</p>
<p>As explained elsewhere, when a source becomes unreachable, the poll process inserts a dummy infinity sample in the shift register for each poll sent. After eight polls, the register returns to its original state.</p>
<p><img src="/archives/pic/flt1.gif" alt="gif">
<img src="/archives/pic/flt2.gif" alt="gif"></p>
<p><strong>Figure 2: Raw (top) and Filtered (bottom) Offsets</strong></p>
<p>Figure 2 shows the performance of the algorithm for a typical Internet path over a 24-hr period. The graph on the left shows the raw offsets produced by the on-wired protocol, while the figure on the right shows the filtered offsets produced by the clock filter algorithm. If we consider the series formed as the absolute value of the offset samples, the mean error is defined as the mean of this series. Thus, the mean error of the raw samples is 0.724 ms, while the mean error of the filtered series is 0.192 ms. Radio engineers would interpret this as a processing gain of 11.5 dB.</p>
<p>The reader might notice the somewhat boxy characteristic of the filtered offsets. Once a sample is selected, it remains selected until a newer sample with lower delay is available. This commonly occurs when an older selected sample is discarded from the shift register. The reason for this is to preserve causality; that is, time always moves forward, never backward. The result can be the loss of up to seven samples in the shift register, or more to the point, the output sample rate can never be less than one in eight input samples. The clock discipline algorithm is specifically designed to operate at this rate.</p>

	  
  </div>
</section>
<footer class="navbar site-footer fixed-bottom py-0">
  <ul class="mx-auto">
    
    <li class="navbar-text" data-toggle="tooltip" data-placement="top" title="Mailing lists" aria-label="Mailing lists">
      <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://lists.ntp.org/listinfo">
        <i class="bi-envelope"></i>
      </a>
    </li>
    
    <li class="navbar-text" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
      <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://twitter.com/ntp">
        <i class="bi-twitter"></i>
      </a>
    </li>
    
    <li class="navbar-text" data-toggle="tooltip" data-placement="top" title="LinkedIn" aria-label="LinkedIn">
      <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/groups/4651343">
        <i class="bi-linkedin"></i>
      </a>
    </li>
    
    <li class="navbar-text" data-toggle="tooltip" data-placement="top" title="Facebook" aria-label="Facebook">
      <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://www.facebook.com/networktimeprotocol">
        <i class="bi-facebook"></i>
      </a>
    </li>
    
    <li class="navbar-text">
      <p>&copy; 2021 <a class="navbar-text text-white" href="https://www.nwtime.org">Network Time Foundation</a></p>	
    </li>
  </ul>
</footer>

</body>
</html>